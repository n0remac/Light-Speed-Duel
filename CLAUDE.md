# Light Speed Duel - Development Guide

## Project Overview

**Light Speed Duel** is a real-time multiplayer space combat game featuring relativistic light-time delays. Players duel at near-light speeds, seeing opponents only as they were, delayed by the time light takes to travel between ships.

**Tech Stack:**
- **Backend**: Go 1.22+ (game simulation, WebSocket server)
- **Frontend**: TypeScript + Canvas (browser client)
- **Build**: esbuild (embedded via Go)

## Architecture

### Directory Structure

```
.
├── main.go                          # Entry point
├── internal/
│   ├── game/                        # Core game logic (Go)
│   │   ├── core.go                  # Vec2, History, physics utilities
│   │   ├── ecs.go                   # Entity component system
│   │   ├── systems.go               # Game systems (movement, missiles)
│   │   ├── perception.go            # Light-time delay calculations
│   │   ├── room.go                  # Game room/lobby management
│   │   ├── ai_*.go                  # AI systems
│   │   └── consts.go                # Game constants
│   └── server/                      # HTTP/WebSocket server (Go)
│       ├── app.go                   # Application bootstrap
│       ├── http.go                  # HTTP handlers, embedded assets
│       ├── ws.go                    # WebSocket handlers
│       ├── dto.go                   # Data transfer objects
│       ├── cmd/webbuild/main.go     # TypeScript build tool (esbuild)
│       └── web/                     # Frontend assets
│           ├── src/                 # TypeScript SOURCE (edit these)
│           │   ├── main.ts          # Game entry point
│           │   ├── lobby.ts         # Lobby entry point
│           │   ├── game.ts          # Game rendering/logic
│           │   ├── net.ts           # WebSocket client
│           │   ├── bus.ts           # Event bus system
│           │   ├── state.ts         # App state management
│           │   ├── tutorial/        # Tutorial system
│           │   ├── story/           # Story/dialogue system
│           │   └── audio/           # Audio engine
│           ├── *.js                 # COMPILED OUTPUT (do not edit)
│           ├── *.html               # HTML templates
│           └── tsconfig.json        # TypeScript config
└── restart-dev.sh                   # Development server script
```

### Key Architecture Patterns

#### Backend (Go)
- **Package structure**: `game` for logic, `server` for networking
- **ECS pattern**: Entity-component-system for game objects
- **Light-time delays**: `perception.go` handles relativistic delays
- **Embedded assets**: Frontend compiled into binary via `//go:embed`
- **Code generation**: `//go:generate go run ./cmd/webbuild` builds TypeScript

#### Frontend (TypeScript)
- **Event-driven**: Central `EventBus` for component communication
- **State management**: Centralized `AppState` and `UIState`
- **Module organization**: Separate systems for game, tutorial, story, audio
- **Type safety**: Strong typing throughout with interfaces

## Important: Source File Locations

⚠️ **CRITICAL**: When working with frontend code:

- **ALWAYS edit `.ts` files** in `internal/server/web/src/`
- **NEVER edit `.js` files** in `internal/server/web/` (they are compiled output)
- `.js` files are generated by the build process and will be overwritten

**Example:**
- ✅ Edit: `internal/server/web/src/game.ts`
- ❌ Don't edit: `internal/server/web/game.js` (generated file)

## Build & Development

### Building the Project

1. **Build TypeScript → JavaScript:**
   ```bash
   go generate ./internal/server
   ```
   This runs esbuild to compile:
   - `src/main.ts` → `client.js`
   - `src/lobby.ts` → `lobby.js`

2. **Build Go binary:**
   ```bash
   go build -o LightSpeedDuel
   ```
   Embeds compiled JS/HTML and builds the server

3. **Run development server:**
   ```bash
   ./restart-dev.sh
   ```
   Or manually:
   ```bash
   go run . -addr :8080
   ```

### Development Workflow

**For TypeScript changes:**
```bash
# 1. Edit .ts files in internal/server/web/src/
# 2. Rebuild JavaScript
go generate ./internal/server
# 3. Rebuild and run Go
go build && ./LightSpeedDuel
```

**For Go changes:**
```bash
go build && ./LightSpeedDuel
```

**Quick iteration script:**
```bash
./restart-dev.sh  # Builds everything and starts server on :8082
```

## Common Patterns & Conventions

### TypeScript Patterns

#### Event Bus Usage
```typescript
// Define events in bus.ts EventMap
export interface EventMap {
  "ship:waypointAdded": { index: number };
  "missile:launched": { routeId: string };
}

// Emit events
bus.emit("ship:waypointAdded", { index: 0 });

// Subscribe to events
const unsubscribe = bus.on("missile:launched", ({ routeId }) => {
  console.log("Missile launched:", routeId);
});
```

#### State Management
```typescript
// Centralized state in state.ts
export interface AppState {
  now: number;
  me: ShipSnapshot | null;
  ghosts: GhostSnapshot[];
  missiles: MissileSnapshot[];
  // ...
}

// Mutations happen via network messages or local updates
state.me = newShipData;
bus.emit("state:updated");
```

### Go Patterns

#### DTOs for Network Messages
```go
// Define in dto.go
type waypointDTO struct {
    X     float64 `json:"x"`
    Y     float64 `json:"y"`
    Speed float64 `json:"speed"`
}

// Use in WebSocket handlers
msg := waypointDTO{X: 100, Y: 200, Speed: 50}
json.NewEncoder(conn).Encode(msg)
```

#### Game Constants
```go
// Define in game/consts.go
const (
    C = 299.0  // Speed of light
    MissileBaseCooldown = 5.0
)
```

## Key Subsystems

### Game Physics (internal/game/)
- **Vec2**: 2D vector math (Add, Sub, Dot, Len, Scale)
- **History**: Circular buffer for light-time lookback
- **Movement system**: Waypoint-based acceleration/deceleration
- **Missile system**: Homing missiles with agro radius

### Networking (internal/server/)
- **WebSocket**: Bidirectional real-time communication
- **Message types**: join, waypoint, missile_config, missile_route, spawn_bot
- **Per-player views**: Server calculates light-delayed state per client

### Frontend Systems

#### Tutorial System (`tutorial/`)
- Step-based tutorial with highlights
- Event-driven progression
- LocalStorage for progress tracking

#### Story System (`story/`)
- Dialogue overlay with choices
- Chapter-based narrative
- Triggers and auto-advance
- Flag system for branching

#### Audio System (`audio/`)
- Web Audio API engine
- Music director with scenes
- SFX with velocity/pan support
- Automatic ducking/unducking

## Testing & Deployment

### Local Testing
```bash
# Terminal 1: Start server
go run . -addr :8080

# Terminal 2: Open browsers
open http://localhost:8080/?room=test&mode=freeplay
```

### Deployment
- GitHub Actions workflow (`.github/workflows/deploy.yml`)
- Builds Linux binary on push to main
- SSH deployment to DigitalOcean
- Systemd service management

## Troubleshooting

### TypeScript changes not appearing
**Problem**: Edited `.ts` file but changes don't show
**Solution**: Run `go generate ./internal/server` then rebuild

### Build errors after TypeScript changes
**Problem**: Type errors in esbuild
**Solution**: Check `tsconfig.json` and fix TypeScript errors in `.ts` files

### WebSocket connection issues
**Problem**: Client can't connect to server
**Solution**: Check server is running, firewall settings, and WebSocket upgrade

## Game Design Notes

### Light-Time Mechanics
- Players see ships/missiles at their **delayed position**
- Delay = `distance / C` where C is speed of light (299 units/s)
- Encourages prediction and strategic positioning
- Own ship also shows delayed position (no privileged info)

### Missile System
- **Speed**: Higher speed = shorter lifetime (harder to catch)
- **Agro radius**: Larger radius = shorter lifetime (easier to detect)
- **Homing**: Pursues enemies within agro radius
- **Cooldown**: Time dilation affects reload (faster ship = longer wait)

## Code Style

- **TypeScript**: Functional style, minimal classes, pure functions preferred
- **Go**: Standard Go conventions, exported names start with capital
- **Comments**: Explain "why" not "what" for complex logic
- **Naming**: Descriptive names, avoid abbreviations except standard ones (DTO, WS, HP)
